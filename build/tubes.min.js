/*
 * tubes.js - 0.0.5 
 * Author : Jacob Lowe <http://jacoblowe.me> 
 */

var jQuery=jQuery?jQuery:require?require("jquery"):null;(function(t){var e=function(t){return this instanceof e?(this.queues={},this.max=t.max?t.max:10,this.maxChannel=t.maxChannel?t.maxChannel:2,this.state=1,this):new e(t)};e.prototype.pipe=function(t,e){return e||(e={}),e.channel||(e.channel=1),this.queues[e.channel]||(this.queues[e.channel]=new this.Queue(e)),e.ajax=t,e.auto=this.state,this.queues[e.channel].addCall(e)},e.prototype.eachQueue=function(t){for(var e in this.queues){var i=this.queues[e];i&&t(i)}},e.prototype.pause=function(){this.state&&(this.state=0,this.eachQueue(function(t){t.lock().stopCalls()}))},e.prototype.resume=function(){this.state||(this.state=1,this.eachQueue(function(t){t.unlock().next()}))},e.prototype.clear=function(){this.eachQueue(function(t){t.removeAllCalls()})},t.Tubes=e})(this);var Tubes=Tubes?Tubes:this.Tubes;(function(t){var e=function(t){return this instanceof e?(this.queueOptions=t,this.maxPriority=t.maxPriority?t.maxPriority:"3",this.calls={},this.emitters={},this.maxCalls=t.maxCalls?t.maxCalls:"3",this.currentCalls=0,this._lock=0,this):new e(t)};e.prototype=t.prototype,e.prototype.lock=function(){return this._lock=1,this},e.prototype.unlock=function(){return this._lock=0,this},e.prototype.doneHandle=function(t,e,i){return function(){t._lock||("number"==typeof t.calls[e][i]&&t.removeCall(e,i),t.next())}},e.prototype.eachCall=function(t){for(var e=0;this.maxPriority+1>e;e+=1){var i=this.calls[e];if(i)for(var s=0;i.length>s;s+=1){var n=this.emitters[i[s]];if(!t(n,e,s))return null}}return!0},e.prototype.addCall=function(t){t.priority||(t.priority=this.maxPriority),this.calls[t.priority]||(this.calls[t.priority]=[]);var e=new this.Emit(t.ajax,t),i=this.calls[t.priority].length;return this.calls[t.priority].push(i),this.currentCalls+=1,this.emitters[i]=e,e.on("done",this.doneHandle(this,t.priority,i)),this._lock||this.next(),function(t){return t}(e)},e.prototype.next=function(){if(!this._lock){var t=this;this.eachCall(function(e){return e&&!e.state&&(e.start(),t.progress=1),t.currentCalls===this.maxCalls?null:!0})}},e.prototype.stopCalls=function(){var t=this;this.eachCall(function(e){return e&&e.xhr&&(e.abort(),e.state=0,t.currentCalls-=1),0===t.currentCalls?null:!0})},e.prototype.removeAllCalls=function(){this.stopCalls(),this.currentCalls=0,this.emitters={},this.calls={}},e.prototype.removeCall=function(t,e){"object"==typeof this.calls[t]&&(this.calls[t].splice(e,1),this.emitters[e]=null,this.currentCalls-=1)},t.prototype.Queue=e})(Tubes),function(t,e){var i=function(t,e){if(!(this instanceof i))return new i(t,e);var s=this,n=function(t,e,i){t(e,i)},r=function(t){return function(e){if(s[t])for(var i=0;s[t].length>i;i+=1){var r=s[t][i];"function"==typeof r&&n(r,xhr,e)}"done"===t&&s.success(e)}};return this.ajax=t,this.open=[],this.state=0,this.success=function(t){return t}(t.success),this.error=t.error,this.connection=[],this.loading=[],this.done=[],this.ajax.success=r("done"),this};i.prototype=t.prototype,i.prototype.on=function(t,e){"object"==typeof this[t]&&"function"==typeof e&&this[t].push(e)},i.prototype.start=function(){this.state=1,this.xhr=e.ajax(this.ajax)},i.prototype.abort=function(){this.xhr.abort()},t.prototype.Emit=i}(Tubes,jQuery);