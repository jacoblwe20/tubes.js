/*
 * tubes.js - 0.0.1 
 * Author : Jacob Lowe <http://jacoblowe.me> 
 */

var jQuery=jQuery?jQuery:require?require("jquery"):null;(function(t){var e=function(t){return this instanceof e?(this.queues={},this.max=t.max?t.max:10,this.maxChannel=t.maxChannel?t.maxChannel:2,this.state=1,this):new e(t)};e.prototype.pipe=function(t,e){return e||(e={}),e.channel||(e.channel=1),this.queues[e.channel]||(this.queues[e.channel]=new this.Queue(e)),e.ajax=t,e.auto=this.state,this.queues[e.channel].addCall(e)},e.prototype.eachQueue=function(t){for(var e in this.queues){var s=this.queues[e];s&&t(s)}},e.prototype.pause=function(){this.state&&(this.state=0,this.eachQueue(function(t){t.stopCalls()}))},e.prototype.resume=function(){this.state||(this.state=1,this.eachQueue(function(t){t.next()}))},e.prototype.clear=function(){this.eachQueue(function(t){t.removeAllCalls()})},t.Tubes=e})(this);var Tubes=Tubes?Tubes:this.Tubes;(function(t){var e=function(t){return this instanceof e?(this.queueOptions=t,this.maxPriority=t.maxPriority?t.maxPriority:"3",this.calls={},this.emitters={},this.maxCalls=t.maxCalls?t.maxCalls:"3",this.currentCalls=0,this):new e(t)};e.prototype=t.prototype,e.prototype.doneHandle=function(t,e,s){"number"==typeof t.calls[e][s]&&t.removeCall(e,s),t.next()},e.prototype.eachCall=function(t){for(var e=0;this.maxPriority+1>e;e+=1){var s=this.calls[e];if(s)for(var i=0;s.length>i;i+=1){var r=this.emitters[s[i]];if(!t(r,e,i))return null}}return!0},e.prototype.addCall=function(t){t.priority||(t.priority=this.maxPriority),this.calls[t.priority]||(this.calls[t.priority]=[]);var e=new this.Emit(t.ajax,t),s=this.calls[t.priority].length;return this.calls[t.priority].push(s),this.currentCalls+=1,this.emitters[s]=e,e.on("done",this.doneHandle(this,t.priority,s)),t.auto&&this.next(),e},e.prototype.next=function(){var t=this;this.eachCall(function(e){return e&&!e.state&&(e.start(),t.currentCalls+=1,t.progress=1),t.currentCalls===this.maxCalls?null:!0})},e.prototype.stopCalls=function(){var t=this;this.eachCall(function(e){return e&&e.progress&&(e.abort(),t.currentCalls-=1),0===t.currentCalls?null:!0})},e.prototype.removeAllCalls=function(){this.calls={}},e.prototype.removeCall=function(t,e){"object"==typeof this.calls[t]&&(this.calls[t].splice(e,1),this.emitters[e]=null,this.calls[t].length||(this.calls[t]=null))},t.prototype.Queue=e})(Tubes),function(t,e){var s=function(t,e){if(!(this instanceof s))return new s(t,e);var i=this,r=function(t){return function(e){if(i[t])for(var s=0;i[t].length>s;s+=1){var r=i[t][s];"function"==typeof r&&r(xhr,e)}"done"===t&&i.success(e)}};return this.ajax=t,this.open=[],this.state=0,this.success=function(t){return t}(t.success),this.error=t.error,this.connection=[],this.loading=[],this.done=[],this.ajax.success=r("done"),this};s.prototype=t.prototype,s.prototype.on=function(t,e){"object"==typeof this[t]&&"function"==typeof e&&this[t].push(e)},s.prototype.start=function(){this.state=1,this.xhr=e.ajax(this.ajax)},s.prototype.abort=function(){that.xhr.abort()},t.prototype.Emit=s}(Tubes,jQuery);