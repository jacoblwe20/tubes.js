/*
 * tubes.js - 0.0.5 
 * Author : Jacob Lowe <http://jacoblowe.me> 
 */

var jQuery=jQuery?jQuery:require?require("jquery"):null;(function(t){var e=function(t){return this instanceof e?(this.queues={},this.max=t.max?t.max:10,this.maxChannel=t.maxChannel?t.maxChannel:2,this.maxCalls=t.maxCalls?t.maxCalls:10,this.state=1,this):new e(t)};e.prototype.pipe=function(t,e){return e||(e={}),e.channel||(e.channel=1),e.maxCalls=this.maxCalls,this.queues[e.channel]||(this.queues[e.channel]=new this.Queue(e)),e.ajax=t,e.auto=this.state,this.queues[e.channel].addCall(e)},e.prototype.eachQueue=function(t){for(var e in this.queues){var s=this.queues[e];s&&t(s)}},e.prototype.pause=function(){this.state&&(this.state=0,this.eachQueue(function(t){t.lock().stopCalls()}))},e.prototype.resume=function(){this.state||(this.state=1,this.eachQueue(function(t){t.unlock().next()}))},e.prototype.clear=function(){this.eachQueue(function(t){t.removeAllCalls()})},t.Tubes=e})(this);var Tubes=Tubes?Tubes:this.Tubes;(function(t){var e=0,s=function(t){return this instanceof s?(this.queueOptions=t,this.maxPriority=t.maxPriority?t.maxPriority:3,this.calls={},this.emitters={},this.maxCalls=t.maxCalls?t.maxCalls:10,this.currentCalls=0,this._lock=0,e+=1,this.id=e,this):new s(t)};s.prototype=t.prototype,s.prototype.lock=function(){return this._lock=1,this},s.prototype.unlock=function(){return this._lock=0,this},s.prototype.doneHandle=function(t,e,s){var r=this;return function(){"number"==typeof r.calls[e][s]&&r.removeCall(e,s),t._lock||t.next()}},s.prototype.eachCall=function(t){for(var e=0;this.maxPriority+1>e;e+=1){var s=this.calls[e];if(s)for(var r=0;s.length>r;r+=1){var i=this.emitters[s[r]];if(!t(i,e,r))return null}}return!0},s.prototype.addCall=function(t){t.priority||(t.priority=this.maxPriority),this.calls[t.priority]||(this.calls[t.priority]=[]);var e=new this.Emit(t.ajax,t),s=this.calls[t.priority].length;return this.calls[t.priority].push(s),this.emitters[s]=e,e.on("done",this.doneHandle(this,t.priority,s)),this._lock||this.next(),function(t){return t}(e)},s.prototype.next=function(){if(!this._lock){var t=this;this.eachCall(function(e){return e&&!e.state&&(e.start(),t.progress=1,t.currentCalls+=1),t.currentCalls===t.maxCalls?null:!0})}},s.prototype.stopCalls=function(){var t=this;this.eachCall(function(e){return e&&e.xhr&&(e.abort(),e.state=0,t.currentCalls-=1),0===t.currentCalls?null:!0})},s.prototype.removeAllCalls=function(){this.stopCalls(),this.currentCalls=0,this.emitters={},this.calls={}},s.prototype.removeCall=function(t,e){"object"==typeof this.calls[t]&&(this.calls[t][e]=null,this.emitters[e]=null,this.currentCalls-=1)},t.prototype.Queue=s})(Tubes),function(t,e){var s=function(t,e){if(!(this instanceof s))return new s(t,e);var r=this,i=function(t,e,s){t(s,e)},n=function(t){return function(e){if(r[t])for(var s=0;r[t].length>s;s+=1){var n=r[t][s];"function"==typeof n&&i(n,xhr,e)}"done"===t&&"function"==typeof r.success&&r.success(e),"error"===t&&"abort"!==e.statusText&&"function"==typeof r.error_&&r.error_(e)}};return this.ajax=t,this.open=[],this.state=0,this.success=function(t){return t}(t.success),this.error_=function(t){return t}(t.error),this.connection=[],this.loading=[],this.done=[],this.error=[],this.ajax.success=n("done"),this.ajax.error=n("error"),this};s.prototype=t.prototype,s.prototype.on=function(t,e){return"object"==typeof this[t]&&"function"==typeof e&&this[t].push(e),this},s.prototype.start=function(){this.state=1,this.xhr=e.ajax(this.ajax)},s.prototype.abort=function(){this.xhr.abort()},t.prototype.Emit=s}(Tubes,jQuery);