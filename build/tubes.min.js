/*
 * tubes.js - 0.0.1 
 * Author : Jacob Lowe <http://jacoblowe.me> 
 */

var jQuery=jQuery?jQuery:require?require("jquery"):null;(function(t){var e=function(t){return this instanceof e?(this.queues={},this.max=t.max?t.max:10,this.maxChannel=t.maxChannel?t.maxChannel:2,this.state=1,this):new e(t)};e.prototype.pipe=function(t,e){return e||(e={}),e.channel||(e.channel=1),this.queues[e.channel]||(this.queues[e.channel]=new this.Queue(e)),e.ajax=t,e.auto=this.state,this.queues[e.channel].addCall(e)},e.prototype.eachQueue=function(t){for(var e in this.queues){var n=this.queues[e];n&&t(n)}},e.prototype.pause=function(){this.state&&(this.state=0,this.eachQueue(function(t){t.stopCalls()}))},e.prototype.resume=function(){this.state||(this.state=1,this.eachQueue(function(t){t.next()}))},e.prototype.clear=function(){this.eachQueue(function(t){t.removeAllCalls()})},t.Tubes=e})(this);var Tubes=Tubes?Tubes:this.Tubes;(function(t){var e=function(t){return this instanceof e?(this.queueOptions=t,this.maxPriority=t.maxPriority?t.maxPriority:"3",this.calls={},this.emitters={},this.maxCalls=t.maxCalls?t.maxCalls:"3",this.currentCalls=0,this):new e(t)};e.prototype=t.prototype,e.prototype.doneHandle=function(t,e,n){"object"==typeof t.calls[e][n]&&t.removeCall(e,n),t.next()},e.prototype.eachCall=function(t){for(var e=0;this.maxPriority+1>e;e+=1){var n=this.emitters[this.calls[e]];if(n)for(var i=n.length-1;i>-1;i-=1){var o=n[i];if(!t(o,e,i))return null}}return!0},e.prototype.addCall=function(t){t.priority||(t.priority=this.maxPriority),this.calls[t.priority]||(this.calls[t.priority]=[]);var e=new this.Emit(t.ajax,t),n=this.calls[t.priority].length;return this.calls[t.priority].push(n),this.currentCalls+=1,this.emitters[n]=e,e.on("done",this.doneHandle(this,t.priority,n)),t.auto&&this.next(),e},e.prototype.next=function(){var t=this;this.eachCall(function(e){return e&&(e.start(),t.currentCalls+=1,t.progress=1),t.currentCalls===this.maxCalls?null:!0})},e.prototype.stopCalls=function(){var t=this;this.eachCall(function(e){return e&&e.progress&&(e.abort(),t.currentCalls-=1),0===t.currentCalls?null:!0})},e.prototype.removeAllCalls=function(){this.calls={}},e.prototype.removeCall=function(t,e){"object"==typeof this.calls[t]&&(this.calls[t].splice(e,1),this.calls[t].length||(this.calls[t]=null))},t.prototype.Queue=e})(Tubes),function(t,e){var n=function(t,e){if(!(this instanceof n))return new n(t,e);var i=this;return this.ajax=t,this.open=[],this.connection=[],this.loading=[],this.done=[],this.onChange=function(){switch(i.xhr.readyState){case 1:i.onOpen(i.xhr);break;case 2:i.onConnection(i.xhr);break;case 3:i.onLoading(i.xhr);break;case 4:i.onDone(i.xhr)}},this};n.prototype=t.prototype,n.prototype.on=function(t,e){"object"==typeof this[t]&&"function"==typeof e&&this[t].push(e)},n.prototype.listen=function(){var t=this,e=function(e){return function(){if(t[e])for(var n=0;t[e].length>n;n+=1){var o=t[e][i];"function"==typeof o&&o(xhr)}}};t.onStart=e("start"),t.onOpen=e("open"),t.onConnection=e("connection"),t.onLoading=e("loading"),t.onDone=e("done")},n.prototype.start=function(){this.xhr=e.ajax(this.ajax),this.xhr.onreadystatechange=this.onChange,this.listen()},n.prototype.abort=function(){that.xhr.abort()},t.prototype.Emit=n}(Tubes,jQuery);